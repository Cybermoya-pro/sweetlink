(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const g of i.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&r(g)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const b=15e3,w=document.getElementById("status-log"),c=document.getElementById("enable-btn"),l=document.getElementById("kpi-value"),u=document.getElementById("badge-status"),E=Array.from(document.querySelectorAll('[data-demo="pulse"]')),S=document.getElementById("mock-chart");let a=null,d=null,f=null;const p=[];function s(e){if(!w)return;const t=new Date().toISOString();w.textContent=`${w.textContent??""}
[${t}] ${e}`.trim()}function L(e,t){const o={id:crypto.randomUUID(),timestamp:Date.now(),level:e,args:t};(a==null?void 0:a.readyState)===WebSocket.OPEN&&d?k([o]):p.push(o)}function k(e){!a||a.readyState!==WebSocket.OPEN||!d||e.length===0||a.send(JSON.stringify({kind:"console",sessionId:d,events:e}))}function v(){const e=["log","info","warn","error","debug"];for(const t of e){const o=console[t].bind(console);console[t]=(...r)=>{o(...r);try{L(t,r)}catch{}}}}const m={updateKpi(e){if(!l)return null;const t=Math.max(0,Math.min(100,Number(e)||0));return l.textContent=`${t.toFixed(0)}%`,l.classList.add("highlight"),window.setTimeout(()=>l.classList.remove("highlight"),600),s(`KPI value updated to ${t.toFixed(0)}%.`),t},toggleBadge(){if(!u)return null;const t=(u.textContent??"").trim()==="beta"?"stable":"beta";return u.textContent=t,u.dataset.state=t,s(`Badge toggled to "${t}".`),t},pulseCard(){const e=document.getElementById("screenshot-card");return e?(e.classList.add("pulse"),window.setTimeout(()=>e.classList.remove("pulse"),800),s("Screenshot card pulse animation triggered."),!0):!1},randomizeChart(){if(!S)return!1;const e=Array.from(S.querySelectorAll(".bar"));for(const t of e){const o=35+Math.random()*60;t.style.height=`${o}%`}return s("Chart bars randomized."),!0}};window.demo=m;async function C(){s("Requesting SweetLink handshake…");const e=await fetch("/api/sweetlink/handshake",{method:"POST"});if(!e.ok){const t=await e.text();throw new Error(`Handshake failed (${e.status}): ${t}`)}return await e.json()}function I(){!d||!a||(y(),f=window.setInterval(()=>{(a==null?void 0:a.readyState)===WebSocket.OPEN&&d&&a.send(JSON.stringify({kind:"heartbeat",sessionId:d}))},b*.8))}function y(){f!==null&&(clearInterval(f),f=null)}function h(e){!a||a.readyState!==WebSocket.OPEN||!d||a.send(JSON.stringify({kind:"commandResult",sessionId:d,result:e}))}async function $(e){if(typeof e.code!="string")throw new Error("SweetLink runScript command is missing code.");const t=Object.getPrototypeOf(async()=>{}).constructor;return await new t("demo",`"use strict"; return (${e.code});`).call(window,m)}async function O(e){const{command:t}=e;if(!t||typeof t!="object")return;const o=performance.now();try{switch(t.type){case"runScript":{const r=await $(t);h({ok:!0,commandId:t.id,durationMs:Math.round(performance.now()-o),data:r});return}case"navigate":{const r=t;if(typeof r.target!="string"||r.target.length===0)throw new Error("Missing navigate target");window.location.assign(r.target),h({ok:!0,commandId:r.id,durationMs:Math.round(performance.now()-o),data:window.location.href});return}default:throw new Error(`Command "${String(t.type)}" is not implemented in the demo client.`)}}catch(r){const n=r instanceof Error?r.message:String(r);h({ok:!1,commandId:t.id,durationMs:Math.round(performance.now()-o),error:n,stack:r instanceof Error&&r.stack?r.stack:void 0})}}function x(e){if(!(e!=null&&e.data))return;let t;try{t=JSON.parse(e.data)}catch(o){s(`Received invalid message: ${o instanceof Error?o.message:String(o)}`);return}switch(t.kind){case"command":O(t);break;case"metadata":s(`CLI attached as "${t.codename}".`);break;case"disconnect":s(`Daemon requested disconnect: ${t.reason??"unknown reason"}`);break;default:s(`Received message: ${String(t.kind??"unknown")}`)}}async function M(e){return await new Promise((t,o)=>{const r=new WebSocket(e.socketUrl);a=r,d=e.sessionId,r.addEventListener("open",()=>{s("Connected. Registering session with daemon…");const n={kind:"register",token:e.sessionToken,sessionId:e.sessionId,url:window.location.href,title:document.title,userAgent:navigator.userAgent,topOrigin:window.location.origin};r.send(JSON.stringify(n)),k(p.splice(0,p.length)),I(),t()}),r.addEventListener("message",n=>x(n)),r.addEventListener("close",n=>{s(`Socket closed (${n.code}${n.reason?`: ${n.reason}`:""}).`),y(),c&&(c.disabled=!1)}),r.addEventListener("error",n=>{const i=n.message??"unknown error";s(`WebSocket error: ${i}`),y(),c&&(c.disabled=!1),o(n.error??new Error(i))})})}async function N(){if(c){c.disabled=!0;try{const e=await C();s(`Handshake granted. Session ${e.sessionId}. Connecting to ${e.socketUrl}…`),await M(e),s('SweetLink session registered. Run "pnpm sweetlink sessions" to inspect.'),m.randomizeChart()}catch(e){const t=e instanceof Error?e.message:String(e);s(`Failed to enable SweetLink: ${t}`),c.disabled=!1}}}v();for(const e of E)e.addEventListener("click",()=>{m.pulseCard()});c==null||c.addEventListener("click",()=>{s("Starting SweetLink activation…"),N()});
